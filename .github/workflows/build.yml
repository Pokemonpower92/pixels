name: Build and Deploy Pipeline

on:
  push:
    branches:
      - main
    paths:
      - "cmd/**"
      - "internal/**"
      - ".github/workflows/**"
      - "build/**"  

permissions:
  contents: write
  packages: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      short_sha: ${{ steps.set-sha.outputs.short_sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect Services
        id: set-matrix
        run: |
          SERVICES=$(find cmd -maxdepth 1 -mindepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n")[:-1]')
          echo "matrix={\"service\":$SERVICES}" >> $GITHUB_OUTPUT
      - name: Set short SHA
        id: set-sha
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          
  build-and-push:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix).service }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Create new tag
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git tag "${{ matrix.service }}-${{ needs.detect-changes.outputs.short_sha }}"
          git push origin "${{ matrix.service }}-${{ needs.detect-changes.outputs.short_sha }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Set repository name
        id: repo
        run: |
          echo "repo=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./build/Dockerfile  
          push: true
          tags: |
            ghcr.io/${{ steps.repo.outputs.repo }}/${{ matrix.service }}:${{ needs.detect-changes.outputs.short_sha }}
            ghcr.io/${{ steps.repo.outputs.repo }}/${{ matrix.service }}:latest
          build-args: |
            SERVICE_NAME=${{ matrix.service }}
            
  deploy-staging:
    steps:
      - name: Create required secrets before deployment
        run: |
          kubectl create secret generic jwt-secret \
            --from-literal=PRIVATE_KEY_PEM="${{ secrets.PRIVATE_KEY_PEM }}" \
            -n pixels-staging \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "✅ JWT secret created/updated"
          
      - name: Deploy service to staging via Argo CD
        run: |
          argocd login argocd-server.argocd.svc.cluster.local:443 --username admin --password ${{ secrets.ARGOCD_PASSWORD }} --insecure
          if [ "${{ matrix.service }}" = "api" ]; then
            echo "Setting pixels image override..."
            argocd app set pixels-staging --kustomize-image pixels=ghcr.io/pokemonpower92/pixels/api:${{ needs.detect-changes.outputs.short_sha }}
          elif [ "${{ matrix.service }}" = "migrate" ]; then
            echo "Setting migrate image override..."
            argocd app set pixels-staging --kustomize-image migrate=ghcr.io/pokemonpower92/pixels/migrate:${{ needs.detect-changes.outputs.short_sha }}
          fi
          echo "✅ Updated ${{ matrix.service }} to ${{ needs.detect-changes.outputs.short_sha }}"
          
  sync-deployment:
    needs: [detect-changes, deploy-staging]
    runs-on: [self-hosted, k3s, pixels]
    if: github.ref == 'refs/heads/main' && always() && !cancelled()
    steps:
      - name: Sync and verify deployment
        run: |
          argocd login argocd-server.argocd.svc.cluster.local:443 --username admin --password ${{ secrets.ARGOCD_PASSWORD }} --insecure
          kubectl delete job pixels-migration -n pixels-staging --ignore-not-found=true
          argocd app sync pixels-staging --timeout 300
          argocd app wait pixels-staging --timeout 600
          argocd app get pixels-staging --output json | jq -r '.status.health.status' | grep -q "Healthy"
          echo "✅ Deployment successful: ${{ needs.detect-changes.outputs.short_sha }}"

  run-integration-tests:
    needs: [detect-changes, sync-deployment]
    runs-on: [self-hosted, k3s, pixels]
    if: github.ref == 'refs/heads/main' && always() && !cancelled()
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Run integration tests
        id: test
        run: |
          echo "🔧 Running integration tests for deployment ${{ needs.detect-changes.outputs.short_sha }}"
          echo "📦 Services deployed: ${{ join(fromJson(needs.detect-changes.outputs.matrix).service, ', ') }}"
          
          # Clean up any existing test jobs
          kubectl delete job pixels-integration-test -n pixels-staging --ignore-not-found=true
          
          # Create and run the integration test job
          cat <<EOF | kubectl apply -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: pixels-integration-test
            namespace: pixels-staging
            labels:
              test-run: "${{ github.run_id }}"
              commit: "${{ needs.detect-changes.outputs.short_sha }}"
          spec:
            ttlSecondsAfterFinished: 300
            backoffLimit: 1
            template:
              spec:
                restartPolicy: Never
                containers:
                - name: integration-tests
                  image: ghcr.io/pokemonpower92/homelab/runner-go:latest
                  workingDir: /workspace
                  securityContext:
                    runAsUser: 0
                    runAsGroup: 0
                  env:
                  - name: TARGET_ENV
                    value: "staging"
                  - name: REPO_URL
                    value: "https://github.com/${{ github.repository }}.git"
                  - name: API_URL
                    value: "http://pixels.pixels-staging.svc.cluster.local:8080"
                  - name: COMMIT_SHA
                    value: "${{ needs.detect-changes.outputs.short_sha }}"
                  - name: DEPLOYED_SERVICES
                    value: "${{ join(fromJson(needs.detect-changes.outputs.matrix).service, ',') }}"
                  command: ["/bin/bash"]
                  args: 
                  - -c
                  - |
                    echo "🔧 Running integration tests for deployment ${{ needs.detect-changes.outputs.short_sha }}"
                    echo "🔗 Target API: \$API_URL"
                    echo "📦 Services deployed: \$DEPLOYED_SERVICES"
                    
                    echo "🔍 Debugging service connectivity..."
                    nslookup pixels-api.pixels-staging.svc.cluster.local || echo "⚠️ DNS lookup failed"
                    
                    echo "📥 Cloning repository..."
                    git clone \$REPO_URL .
                    git checkout \$COMMIT_SHA
                    
                    run_test.sh test-integration
                  resources:
                    limits:
                      memory: "512Mi"
                      cpu: "500m"
                    requests:
                      memory: "256Mi"
                      cpu: "250m"
          EOF
          
          echo "⏳ Waiting for integration tests to complete..."
          
          # Wait for the job to complete (success or failure)
          if kubectl wait --for=condition=complete job/pixels-integration-test -n pixels-staging --timeout=600s; then
            echo "✅ Integration tests PASSED!"
          else
            echo "❌ Integration tests FAILED!"
            kubectl logs job/pixels-integration-test -n pixels-staging || true
            exit 1
          fi

      - name: Rollback and revert on test failure
        if: failure()
        run: |
          echo "🚨 Integration tests failed - performing automatic rollback and revert"
          
          # Tools are pre-installed in the custom runner image! 🎉
          echo "⚡ Step 1: ArgoCD rollback (immediate)"
          argocd login argocd-server.argocd.svc.cluster.local:443 --username admin --password ${{ secrets.ARGOCD_PASSWORD }} --insecure
          argocd app rollback pixels-staging
          
          # Use a shorter timeout and don't fail if wait times out
          echo "⏳ Waiting for rollback to complete..."
          timeout 60 argocd app wait pixels-staging || echo "⚠️ Rollback initiated but wait timed out (this is OK)"
          
          echo "✅ ArgoCD rollback complete - application restored"
          
          # 2. Revert git commit to keep things in sync
          echo "🧹 Step 2: Git revert (cleanup)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git revert ${{ github.sha }} --no-edit -m "Auto-revert: integration tests failed for ${{ needs.detect-changes.outputs.short_sha }}"
          git push origin main
          echo "✅ Git revert complete"
          
          echo ""
          echo "🎯 RECOVERY SUMMARY:"
          echo "❌ Failed deployment: ${{ needs.detect-changes.outputs.short_sha }}"
          echo "🔄 ArgoCD rolled back to previous working version"
          echo "📝 Git commit reverted to keep history clean"
          echo "📋 Check test logs above for failure details"
          echo "🔗 ArgoCD UI: kubectl port-forward svc/argocd-server -n argocd 8080:443"

  deployment-summary:
    needs: [detect-changes, run-integration-tests]
    runs-on: [self-hosted, k3s, pixels]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "🎯 DEPLOYMENT SUMMARY"
          echo "📝 Commit: ${{ needs.detect-changes.outputs.short_sha }}"
          echo "🏷️  Services: ${{ join(fromJson(needs.detect-changes.outputs.matrix).service, ', ') }}"
          
          if [[ "${{ needs.run-integration-tests.result }}" == "success" ]]; then
            echo "✅ DEPLOYMENT SUCCESSFUL!"
            echo "🎉 All services deployed and integration tests passed"
            echo "🚀 Deployment ${{ needs.detect-changes.outputs.short_sha }} is live in staging"
          else
            echo "❌ DEPLOYMENT FAILED AND ROLLED BACK"
            echo "🔄 Application reverted to previous working version"
            echo "💡 Check integration test failure logs above"
          fi
          
          echo ""
          echo "🔗 Useful commands:"
          echo "   kubectl get pods -n pixels-staging"
          echo "   kubectl port-forward svc/argocd-server -n argocd 8080:443"
          echo "   argocd app get pixels-staging"